name: release

on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'The branch to create the release from'
        required: false
        type: string
        default: ''
      version:
        description: 'The version to tag the release as'
        required: false
        type: string
        default: ''

permissions: {}

jobs:
  release:
    runs-on: [ ubuntu-latest ]

    steps:

      - name: Checkout code
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0
        with:
          fetch-depth: 0
          persist-credentials: true # zizmor: ignore[artipacked] Needed to push tag
          ref: ${{ github.event.inputs.branch || github.event.repository.default_branch }}
          show-progress: false
          token: ${{ secrets.COSTELLOBOT_TOKEN }}

      - name: Get version
        id: get-version
        shell: pwsh
        env:
          VERSION: ${{ github.event.inputs.version }}
        run: |
          $version = ${env:VERSION}
          if (string::IsNullOrEmpty($version)) {
            $properties = Join-Path "." "Directory.Build.props"
            $xml = [xml](Get-Content $properties)
            $version = $xml.SelectSingleNode('Project/PropertyGroup/VersionPrefix').InnerText
          }
          "version=${version}" >> ${env:GITHUB_OUTPUT}

      - name: Configure Git
        shell: pwsh
        env:
          GIT_COMMIT_USER_EMAIL: ${{ vars.GIT_COMMIT_USER_EMAIL }}
          GIT_COMMIT_USER_NAME: ${{ vars.GIT_COMMIT_USER_NAME }}
        run: |
          git config user.email ${env:GIT_COMMIT_USER_EMAIL} | Out-Null
          git config user.name ${env:GIT_COMMIT_USER_NAME} | Out-Null

      - name: Create and push tag
        env:
          VERSION: ${{ steps.get-version.outputs.version }}
        run: |
          TAG="v${VERSION}"
          git tag "${TAG}" && git push origin "refs/tags/$TAG"
